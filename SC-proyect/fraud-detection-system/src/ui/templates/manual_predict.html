{% extends "layout.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-search"></i> Predicción de Fraude Manual</h4>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">Ingresa los 10 datos de la transacción para analizar si es fraudulenta</p>
                
                <!-- Estado de la API -->
                <div class="alert alert-info mb-4" role="alert">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Conectado a: http://127.0.0.1:5000</strong> 
                    <span id="api-status" class="badge bg-success ms-2">Conectado</span>
                </div>
                
                <form id="predictionForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">ID Transacción</label>
                                <input type="number" class="form-control" id="Unnamed: 0" name="Unnamed: 0" 
                                        placeholder="1" required>
                                <small class="text-muted">Identificador único</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Monto ($)</label>
                                <input type="number" step="0.01" class="form-control" id="amt" name="amt" 
                                        placeholder="150.50" required>
                                <small class="text-muted">Ej: 150.50</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Número de Tarjeta</label>
                                <input type="number" class="form-control" id="cc_num" name="cc_num" 
                                        placeholder="4532015112830366" required>
                                <small class="text-muted">16 dígitos</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Población Ciudad</label>
                                <input type="number" class="form-control" id="city_pop" name="city_pop" 
                                    placeholder="250000" required>
                                <small class="text-muted">Población de la ciudad</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Código Postal</label>
                                <input type="number" class="form-control" id="zip" name="zip" 
                                    placeholder="10001" required>
                                <small class="text-muted">5 dígitos</small>
                            </div>
                        </div>
                        
                        <!-- columna2 -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Latitud Cliente</label>
                                <input type="number" step="0.000001" class="form-control" id="lat" name="lat" 
                                        placeholder="40.7128" required>
                                <small class="text-muted">Ej: 40.7128 (Nueva York)</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Longitud Cliente</label>
                                <input type="number" step="0.000001" class="form-control" id="long" name="long" 
                                        placeholder="-74.0060" required>
                                <small class="text-muted">Ej: -74.0060</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Latitud Comercio</label>
                                <input type="number" step="0.000001" class="form-control" id="merch_lat" name="merch_lat" 
                                        placeholder="34.0522" required>
                                <small class="text-muted">Ej: 34.0522 (Los Ángeles)</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Longitud Comercio</label>
                                <input type="number" step="0.000001" class="form-control" id="merch_long" name="merch_long" 
                                        placeholder="-118.2437" required>
                                <small class="text-muted">Ej: -118.2437</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Timestamp Unix</label>
                                <input type="number" class="form-control" id="unix_time" name="unix_time" 
                                        placeholder="1705267200" required>
                                <small class="text-muted">Segundos desde 1 Ene 1970</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn">
                            <i class="bi bi-search me-2"></i> Analizar Transacción
                        </button>
                    </div>
                </form>
                
                <div id="resultContainer" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <div id="resultContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Verificar estado de la API al cargar
checkAPIStatus();

function checkAPIStatus() {
    fetch('/api/health')
        .then(response => response.json())
        .then(data => {
            const statusBadge = document.getElementById('api-status');
            if (data.api_status === 'online') {
                statusBadge.className = 'badge bg-success ms-2';
                statusBadge.textContent = 'Conectado';
            } else {
                statusBadge.className = 'badge bg-danger ms-2';
                statusBadge.textContent = 'Desconectado';
                showError('La API de backend está desconectada. Verifica que esté corriendo en puerto 5000.');
            }
        })
        .catch(error => {
            console.error('Error checking API:', error);
            document.getElementById('api-status').className = 'badge bg-warning ms-2';
            document.getElementById('api-status').textContent = 'Error';
        });
}

document.getElementById('predictionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    
    const formData = new FormData(this);
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        if (['Unnamed: 0', 'cc_num', 'city_pop', 'zip', 'unix_time'].includes(key)) {
            data[key] = parseInt(value) || 0;
        } else if (['amt', 'lat', 'long', 'merch_lat', 'merch_long'].includes(key)) {
            data[key] = parseFloat(value) || 0.0;
        } else {
            data[key] = value;
        }
    }
    
    if (!validateData(data)) {
        return;
    }
    
    // mostrar carga
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Analizando...';
    submitBtn.disabled = true;
    
    // Enviar datos a la API
    fetch('/api/predict_manual', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        
        showResult(result);
    })
    .catch(error => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        
        console.error('Error:', error);
        showError('Error al conectar con el servidor: ' + error.message);
    });
});

function validateData(data) {
    const errors = [];
    
    if (!data['Unnamed: 0'] || data['Unnamed: 0'] <= 0) {
        errors.push('ID Transacción debe ser mayor a 0');
    }
    
    if (!data['amt'] || data['amt'] <= 0) {
        errors.push('Monto debe ser mayor a 0');
    }
    
    if (!data['cc_num'] || data['cc_num'].toString().length < 15) {
        errors.push('Número de tarjeta debe tener al menos 15 dígitos');
    }
    
    if (!data['zip'] || data['zip'].toString().length < 4) {
        errors.push('Código postal inválido');
    }
    
    if (!data['unix_time'] || data['unix_time'] < 1000000000) {
        errors.push('Timestamp Unix inválido (debe ser después de 2001)');
    }
    
    if (errors.length > 0) {
        showError('Errores de validación:<br>' + errors.join('<br>'));
        return false;
    }
    
    return true;
}

function showResult(result) {
    const container = document.getElementById('resultContainer');
    const content = document.getElementById('resultContent');
    
    if (result.error) {
        content.innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="bi bi-exclamation-triangle"></i> Error en la predicción</h5>
                <p class="mb-2"><strong>${result.message || 'Error desconocido'}</strong></p>
                ${result.details ? `<p class="small mb-0">${result.details}</p>` : ''}
            </div>
        `;
        container.style.display = 'block';
        return;
    }
    
    const isFraud = result.is_fraud;
    const probability = (result.probability * 100).toFixed(2);
    const riskLevel = result.risk_level;
    const confidence = (result.confidence * 100).toFixed(1);
    const amount = result.amount ? '$' + parseFloat(result.amount).toFixed(2) : 'N/A';
    
    let alertClass, icon, title, message, riskColor;
    
    if (isFraud) {
        alertClass = 'danger';
        icon = 'exclamation-triangle-fill';
        title = '¡ALERTA DE FRAUDE!';
        message = 'Se ha detectado una transacción fraudulenta.';
        riskColor = 'danger';
    } else if (probability > 70) {
        alertClass = 'warning';
        icon = 'exclamation-triangle';
        title = 'TRANSACCIÓN SOSPECHOSA';
        message = 'Esta transacción presenta características inusuales.';
        riskColor = 'warning';
    } else {
        alertClass = 'success';
        icon = 'check-circle-fill';
        title = 'TRANSACCIÓN NORMAL';
        message = 'La transacción parece legítima.';
        riskColor = 'success';
    }
    
    content.innerHTML = `
        <div class="alert alert-${alertClass}">
            <div class="d-flex align-items-center">
                <i class="bi bi-${icon} display-5 me-3"></i>
                <div class="flex-grow-1">
                    <h3 class="alert-heading mb-1">${title}</h3>
                    <p class="mb-0">${message}</p>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-md-6">
                <table class="table table-bordered">
                    <tr>
                        <td><strong>ID Transacción:</strong></td>
                        <td>${result.transaction_id || 'N/A'}</td>
                    </tr>
                    <tr>
                        <td><strong>Monto:</strong></td>
                        <td>${amount}</td>
                    </tr>
                    <tr>
                        <td><strong>Probabilidad de fraude:</strong></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                    <div class="progress-bar bg-${riskColor}" 
                                        role="progressbar" 
                                        style="width: ${probability}%">
                                    </div>
                                </div>
                                <span class="badge bg-${riskColor}">${probability}%</span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Nivel de riesgo:</strong></td>
                        <td><span class="badge bg-${riskColor}">${riskLevel}</span></td>
                    </tr>
                    <tr>
                        <td><strong>Confianza del modelo:</strong></td>
                        <td>${confidence}%</td>
                    </tr>
                    <tr>
                        <td><strong>Resultado final:</strong></td>
                        <td><strong class="text-${riskColor}">${isFraud ? 'FRAUDE DETECTADO' : 'TRANSACCIÓN NORMAL'}</strong></td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Recomendaciones</h6>
                    </div>
                    <div class="card-body">
                        ${getRecommendations(isFraud, probability)}
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn btn-outline-primary" onclick="resetForm()">
                                <i class="bi bi-arrow-repeat me-2"></i> Analizar otra transacción
                            </button>
                            ${isFraud ? `
                            <button class="btn btn-outline-danger" onclick="reportFraud()">
                                <i class="bi bi-flag me-2"></i> Reportar fraude
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.style.display = 'block';
    container.scrollIntoView({ behavior: 'smooth' });
}

function getRecommendations(isFraud, probability) {
    if (isFraud) {
        return `
            <ul class="mb-0">
                <li><strong>Bloquear la tarjeta</strong> inmediatamente</li>
                <li>Notificar al titular de la cuenta</li>
                <li>Reportar a la entidad bancaria</li>
                <li>Guardar evidencia para investigación</li>
            </ul>
        `;
    } else if (probability > 70) {
        return `
            <ul class="mb-0">
                <li>Verificar identidad del cliente</li>
                <li>Solicitar autenticación adicional</li>
                <li>Monitorear transacciones similares</li>
                <li>Reportar si hay más anomalías</li>
            </ul>
        `;
    } else {
        return `
            <ul class="mb-0">
                <li>Transacción aprobada normalmente</li>
                <li>Continuar con el proceso estándar</li>
                <li>Monitoreo rutinario activado</li>
                <li>Sin acciones adicionales requeridas</li>
            </ul>
        `;
    }
}

function showError(message) {
    const content = document.getElementById('resultContent');
    content.innerHTML = `
        <div class="alert alert-danger">
            <h5><i class="bi bi-exclamation-triangle"></i> Error</h5>
            <p>${message}</p>
        </div>
    `;
    document.getElementById('resultContainer').style.display = 'block';
}

function resetForm() {
    document.getElementById('predictionForm').reset();
    document.getElementById('resultContainer').style.display = 'none';
}


</script>
{% endblock %}